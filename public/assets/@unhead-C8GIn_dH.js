const t=["base","meta","link","style","script","noscript"],e=["base","title","titleTemplate","bodyAttrs","htmlAttrs","templateParams"],o=["tagPosition","tagPriority","tagDuplicateStrategy","children","innerHTML","textContent","processTemplateParams"];function n(t){return t._h||function(t){let e=9;for(let o=0;o<t.length;)e=Math.imul(e^t.charCodeAt(o++),9**9);return(65536+(e^e>>>9)).toString(16).substring(1,8).toLowerCase()}(t._d?t._d:`${t.tag}:${t.textContent||t.innerHTML||""}:${Object.entries(t.props).map((([t,e])=>`${t}:${String(e)}`)).join(",")}`)}function r(t,o){const{props:n,tag:r}=t;if(e.includes(r))return r;if("link"===r&&"canonical"===n.rel)return"canonical";if(n.charset)return"charset";const s=["id"];"meta"===r&&s.push("name","property","http-equiv");for(const e of s)if(void 0!==n[e]){return`${r}:${e}:${String(n[e])}`}return!1}function s(t,e){const o="class"===t?" ":";";return"object"!=typeof e||Array.isArray(e)||(e=Object.entries(e).filter((([,t])=>t)).map((([e,o])=>"style"===t?`${e}:${o}`:e))),(Array.isArray(e)?e.join(o):e)?.split(o).filter((t=>t.trim())).filter(Boolean).join(o)}async function i(t,e){for(const n of Object.keys(t))if(["class","style"].includes(n))t[n]=s(n,t[n]);else if(t[n]instanceof Promise&&(t[n]=await t[n]),!o.includes(n)){const e=String(t[n]),o=n.startsWith("data-");"true"===e||""===e?t[n]=!o||"true":t[n]||(o&&"false"===e?t[n]="false":delete t[n])}return t}async function a(e,o={}){const s=o.delayFn||(t=>setTimeout(t,10));return e._domUpdatePromise=e._domUpdatePromise||new Promise((a=>s((async()=>{await async function(e,o={}){const s=o.document||e.resolvedOptions.document;if(!s||!e.dirty)return;const a={shouldRender:!0,tags:[]};if(await e.hooks.callHook("dom:beforeRender",a),!a.shouldRender)return;const d=(await e.resolveTags()).map((e=>({tag:e,id:t.includes(e.tag)?n(e):e.tag,shouldRender:!0})));let l=e._dom;if(!l){l={elMap:{htmlAttrs:s.documentElement,bodyAttrs:s.body}};for(const e of["body","head"]){const o=s[e]?.children,a=[];for(const e of[...o].filter((e=>t.includes(e.tagName.toLowerCase())))){const t={tag:e.tagName.toLowerCase(),props:await i(e.getAttributeNames().reduce(((t,o)=>({...t,[o]:e.getAttribute(o)})),{})),innerHTML:e.innerHTML};let o=1,s=r(t);for(;s&&a.find((t=>t._d===s));)s=`${s}:${o++}`;t._d=s||void 0,a.push(t),l.elMap[e.getAttribute("data-hid")||n(t)]=e}}}function c(t,e,o){const n=`${t}:${e}`;l.sideEffects[n]=o,delete l.pendingSideEffects[n]}function f({id:t,$el:e,tag:o}){const n=o.tag.endsWith("Attrs");l.elMap[t]=e,n||(["textContent","innerHTML"].forEach((t=>{o[t]&&o[t]!==e[t]&&(e[t]=o[t])})),c(t,"el",(()=>{l.elMap[t]?.remove(),delete l.elMap[t]})));for(const[r,i]of Object.entries(o._eventHandlers||{}))""!==e.getAttribute(`data-${r}`)&&(("bodyAttrs"===o.tag?s.defaultView:e).addEventListener(r.replace("on",""),i.bind(e)),e.setAttribute(`data-${r}`,""));Object.entries(o.props).forEach((([o,r])=>{const s=`attr:${o}`;if("class"===o)for(const i of(r||"").split(" ").filter(Boolean))n&&c(t,`${s}:${i}`,(()=>e.classList.remove(i))),!e.classList.contains(i)&&e.classList.add(i);else if("style"===o)for(const n of(r||"").split(";").filter(Boolean)){const[o,...r]=n.split(":").map((t=>t.trim()));c(t,`${s}:${n}:${o}`,(()=>{e.style.removeProperty(o)})),e.style.setProperty(o,r.join(":"))}else e.getAttribute(o)!==r&&e.setAttribute(o,!0===r?"":String(r)),n&&c(t,s,(()=>e.removeAttribute(o)))}))}l.pendingSideEffects={...l.sideEffects||{}},l.sideEffects={};const u=[],p={bodyClose:void 0,bodyOpen:void 0,head:void 0};for(const n of d){const{tag:e,shouldRender:o,id:r}=n;o&&("title"!==e.tag?(n.$el=n.$el||l.elMap[r],n.$el?f(n):t.includes(e.tag)&&u.push(n)):s.title=e.textContent)}for(const t of u){const e=t.tag.tagPosition||"head";t.$el=s.createElement(t.tag.tag),f(t),p[e]=p[e]||s.createDocumentFragment(),p[e].appendChild(t.$el)}for(const t of d)await e.hooks.callHook("dom:renderTag",t,s,c);p.head&&s.head.appendChild(p.head),p.bodyOpen&&s.body.insertBefore(p.bodyOpen,s.body.firstChild),p.bodyClose&&s.body.appendChild(p.bodyClose),Object.values(l.pendingSideEffects).forEach((t=>t())),e._dom=l,e.dirty=!1,await e.hooks.callHook("dom:rendered",{renders:d})}(e,o),delete e._domUpdatePromise,a()}))))}function d(t){return e=>{const o=e.resolvedOptions.document?.head.querySelector('script[id="unhead:payload"]')?.innerHTML||!1;return o&&e.push(JSON.parse(o)),{mode:"client",hooks:{"entries:updated":function(e){a(e,t)}}}}}export{d as D};
